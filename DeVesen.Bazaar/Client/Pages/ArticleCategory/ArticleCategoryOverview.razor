@using DeVesen.Bazaar.Client.Models
@using DeVesen.Bazaar.Client.Pages.ArticleCategory.Components
@using DeVesen.Bazaar.Client.State
@using DeVesen.Bazaar.Client.State.ArticleCategory
@using DeVesen.Bazaar.Client.State.Title
@using Fluxor

@page "/article-category"

@inherits Fluxor.Blazor.Web.Components.FluxorComponent

@inject TitleFacade TitleFacade
@inject StateFacade StateFacade
@inject IState<ArticleCategoryState> ArticleCategoryState
@inject Services.DialogService DialogService

<ArticleCategoryOverviewToolbar @bind-SearchText="@_searchText"
                                @bind-SearchText:after="@ReloadElements"
                                OnCreateBtnClick="@CreateArticleCategoryAsync" />

<MudTable T="ArticleCategory"
          FixedHeader
          Hover
          Items="@ArticleCategoryState.Value.Items"
          SortLabel="Sort By"
          OnRowClick="ModifyArticleCategoryAsync">
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<ArticleCategory, object>(x => x.Name)">Bezeichnung</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Bezeichnung">@context.Name</MudTd>
    </RowTemplate>
</MudTable>

@code {

    private string? _searchText;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        TitleFacade.SetCaption("Kategorien");
    }

    private async Task CreateArticleCategoryAsync()
    {
        await DialogService.CreateArticleCategoryAsync();
        
        ReloadElements();
    }

    private async Task ModifyArticleCategoryAsync(TableRowClickEventArgs<ArticleCategory> args)
    {
        await DialogService.ModifyArticleCategoryAsync(args.Item!);

        ReloadElements();
    }

    private void ReloadElements()
    {
        StateFacade.ArticleCategory.Fetch();

        StateHasChanged();
    }
}
