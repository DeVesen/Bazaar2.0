@using DeVesen.Bazaar.Client.Extensions
@using DeVesen.Bazaar.Shared.Events

@implements IAsyncDisposable;

@inject ArticleHubConnectionService ArticleHub;

@code {

    private IDisposable _addedActionHandle = null!;
    private IDisposable _updatedActionHandle = null!;
    private IDisposable _removedActionHandle = null!;
    private IDisposable _statusChangedActionHandle = null!;

    [Parameter]
    public EventCallback<IEnumerable<ArticleAddedArgs>> Added { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<ArticleUpdatedArgs>> Updated { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<ArticleRemovedArgs>> Removed { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<ArticleStatusChangedArgs>> StatusChanged { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await ArticleHub.StartAsync();
        
        _addedActionHandle = ArticleHub.RegisterOnAdded(OnAdded);
        _updatedActionHandle = ArticleHub.RegisterOnUpdated(OnUpdated);
        _removedActionHandle = ArticleHub.RegisterOnRemoved(OnRemoved);
        _statusChangedActionHandle = ArticleHub.RegisterOnStatusChanged(OnStatusChanged);
    }

    private void OnAdded(IEnumerable<ArticleAddedArgs> args)
    {
        Added.InvokeAsync(args);
    }

    private void OnUpdated(IEnumerable<ArticleUpdatedArgs> args)
    {
        Updated.InvokeAsync(args);
    }

    private void OnRemoved(IEnumerable<ArticleRemovedArgs> args)
    {
        Removed.InvokeAsync(args);
    }

    private void OnStatusChanged(IEnumerable<ArticleStatusChangedArgs> args)
    {
        StatusChanged.InvokeAsync(args);
    }

    public async ValueTask DisposeAsync()
    {
        // _addedActionHandle.Dispose();
        // _updatedActionHandle.Dispose();
        // _removedActionHandle.Dispose();
        // _statusChangedActionHandle.Dispose();

        await ArticleHub.StopAsync();
    }

}